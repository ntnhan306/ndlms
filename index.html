<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NdLMS ‚Äì GitHub Uploader</title>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: linear-gradient(135deg,#f8fafc,#e2e8f0);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0f172a;
}

.card {
  background: #ffffff;
  width: 480px;
  padding: 26px;
  border-radius: 18px;
  box-shadow: 0 20px 45px rgba(0,0,0,.12);
}

h2 {
  margin-top: 0;
  color: #2563eb;
}

p { font-size: 14px; }

input[type=file] {
  width: 100%;
  margin: 12px 0;
}

.file-box {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 10px;
  min-height: 90px;
  background: #f8fafc;
  font-size: 14px;
  margin-bottom: 14px;
}
.file {
  background: #e5edff;
  padding: 6px 8px;
  border-radius: 6px;
  margin-bottom: 6px;
}
.empty { color: #64748b; }

button {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: #2563eb;
  color: #fff;
  font-size: 16px;
  cursor: pointer;
}
button:disabled { opacity: .6; }

.progress {
  margin-top: 14px;
  width: 100%;
  height: 10px;
  background: #e5e7eb;
  border-radius: 999px;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg,#3b82f6,#2563eb);
  transition: width .3s;
}
.progress-text {
  font-size: 13px;
  margin-top: 6px;
  color: #475569;
}

.links a {
  display: block;
  font-size: 13px;
  margin-top: 4px;
  color: #2563eb;
  text-decoration: none;
}
.links a:hover { text-decoration: underline; }

/* Decode log popup */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.popup {
  background: #ffffff;
  width: 540px;
  max-height: 380px;
  padding: 18px;
  border-radius: 14px;
  overflow: auto;
  font-family: Consolas, monospace;
  font-size: 13px;
  white-space: pre-wrap;
  box-shadow: 0 20px 40px rgba(0,0,0,.2);
}
</style>
</head>

<body>

<div class="card">
  <h2>üì§ NdLMS File Uploader</h2>
  <p>Upload nhi·ªÅu file ‚Üí commit v√†o repo <b>file</b> b·∫±ng GitHub Actions</p>

  <input type="file" id="files" multiple>

  <div class="file-box" id="fileBox">
    <div class="empty">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn</div>
  </div>

  <button id="btn" onclick="upload()">üíæ L∆∞u & Upload</button>

  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-text" id="progressText"></div>

  <div class="links" id="links"></div>
</div>

<!-- Decode realtime popup -->
<div class="overlay" id="overlay">
  <div class="popup" id="popup"></div>
</div>

<script>
const fileInput = document.getElementById('files');
const fileBox = document.getElementById('fileBox');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const overlay = document.getElementById('overlay');
const popup = document.getElementById('popup');
const btn = document.getElementById('btn');

fileInput.onchange = () => {
  const fs = [...fileInput.files];
  if (!fs.length) {
    fileBox.innerHTML = '<div class="empty">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn</div>';
    return;
  }
  fileBox.innerHTML = fs.map(f =>
    `<div class="file">üìÑ ${f.name} (${(f.size/1024).toFixed(1)} KB)</div>`
  ).join('');
};

function setProgress(p, text) {
  progressBar.style.width = p + '%';
  progressText.innerText = text;
}

function logDecode(text) {
  overlay.style.display = 'flex';
  popup.textContent += text + "\n\n";
}

async function upload() {
  const files = [...fileInput.files];
  if (!files.length) return alert('Ch∆∞a ch·ªçn file');

  btn.disabled = true;
  popup.textContent = '';
  setProgress(5, 'Chu·∫©n b·ªã d·ªØ li·ªáu‚Ä¶');

  const payload = [];
  let done = 0;

  for (const f of files) {
    const buf = await f.arrayBuffer();
    const bytes = new Uint8Array(buf);

    let preview;
    try {
      preview = new TextDecoder().decode(bytes.slice(0, 300));
    } catch {
      preview = '[Binary data]';
    }

    logDecode(
`üìÑ FILE: ${f.name}
üì¶ SIZE: ${f.size} bytes
üß™ DECODE PREVIEW (300 bytes):
${preview}
--------------------------------`
    );

    payload.push({
      name: f.name,
      content: btoa(String.fromCharCode(...bytes))
    });

    done++;
    setProgress(
      5 + Math.round(done / files.length * 40),
      `ƒê√£ x·ª≠ l√Ω ${done}/${files.length} file`
    );

    // await new Promise(r => setTimeout(r, 500));
  }

  try {
    setProgress(55, 'G·ª≠i workflow GitHub Actions‚Ä¶');

    await fetch(
      'https://api.github.com/repos/ntnhan306/ndlms/actions/workflows/upload.yml/dispatches',
      {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ref: 'main',
          inputs: { files: JSON.stringify(payload) }
        })
      }
    );

    setProgress(100, 'Ho√†n t·∫•t ‚Äì workflow ƒëang ch·∫°y');
    setTimeout(() => overlay.style.display = 'none', 1500);

    document.getElementById('links').innerHTML = files.map(f =>
      `<a target="_blank"
         href="https://raw.githubusercontent.com/ntnhan306/file/main/${f.name}">
         üîó ${f.name}
       </a>`
    ).join('');

  } catch (e) {
    alert('Upload th·∫•t b·∫°i');
    setProgress(0, '');
    overlay.style.display = 'none';
  }

  btn.disabled = false;
}
</script>

</body>
</html>
