name: File Uploader into ndlms/main

on:
  # Lắng nghe sự kiện được gửi từ Serverless Gateway
  repository_dispatch:
    types: [upload_files_commit] 

jobs:
  upload_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code on 'main' branch
        uses: actions/checkout@v4
        with:
          # Checkout đúng nhánh mục tiêu
          ref: ${{ github.event.client_payload.branch }} 
          # Sử dụng SECRET TOKEN đã được người dùng cấu hình (cần quyền 'repo')
          token: ${{ secrets.TOKEN }} 

      - name: Perform Multi-File Commit using Git Database API
        uses: actions/github-script@v7
        with:
          # SỬ DỤNG SECRET TOKEN MÀ BẠN ĐÃ TẠO
          github-token: ${{ secrets.TOKEN }} 
          script: |
            const payload = context.payload.client_payload;
            const branch = payload.branch || 'main';
            const commitMessage = payload.commit_message || '.';
            const files = JSON.parse(payload.files_payload || '[]');

            if (files.length === 0) {
              console.log('Không có file nào được truyền. Action kết thúc.');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // --- 1. Lấy SHA của HEAD commit ---
            const { data: { object: { sha: baseCommitSha } } } = await github.rest.git.getRef({
              owner, repo, ref: `heads/${branch}`
            });
            
            // 2. Lấy Tree SHA
            const { data: { tree: { sha: baseTreeSha } } } = await github.rest.git.getCommit({
              owner, repo, commit_sha: baseCommitSha
            });
            
            // 3. Tạo Blobs và Tree Items (Giống các bước trước)
            const treeItems = [];
            const rawUrls = [];
            
            for (const file of files) {
              const { data: blobData } = await github.rest.git.createBlob({
                owner, repo, 
                content: file.content_base64,
                encoding: 'base64'
              });
              
              treeItems.push({
                path: file.filename,
                mode: '100644',
                type: 'blob',
                sha: blobData.sha
              });
              rawUrls.push(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${file.filename}`);
            }

            // 4. Tạo New Tree
            const { data: newTreeData } = await github.rest.git.createTree({
              owner, repo, base_tree: baseTreeSha, tree: treeItems
            });

            // 5. Tạo New Commit
            const { data: newCommitData } = await github.rest.git.createCommit({
              owner, repo, message: commitMessage, tree: newTreeData.sha, parents: [baseCommitSha]
            });
            
            // 6. Cập nhật HEAD (ref)
            await github.rest.git.updateRef({
              owner, repo, ref: `heads/${branch}`, sha: newCommitData.sha
            });
            
            console.log(`✅ Commit thành công vào nhánh ${branch}! SHA: ${newCommitData.sha}`);
            console.log('--- Link Raw ---');
            rawUrls.forEach(url => console.log(url));
        
        env:
          PAYLOAD_FILES: ${{ github.event.client_payload.files_payload }}
          PAYLOAD_BRANCH: ${{ github.event.client_payload.branch }}
          PAYLOAD_MESSAGE: ${{ github.event.client_payload.commit_message }}
