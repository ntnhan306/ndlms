name: File Uploader into external repo (file)

on:
  repository_dispatch:
    types: [upload_files_commit] 

jobs:
  upload_commit:
    runs-on: ubuntu-latest
    steps:
      # Bước 1: Không cần checkout repo đích, chỉ cần có token có quyền.
      # Bước 2: Perform Multi-File Commit
      - name: Perform Multi-File Commit into TARGET Repo
        uses: actions/github-script@v7
        with:
          # Sử dụng SECRET TOKEN đã cấu hình (PAT có quyền ghi vào ntnhan306/file)
          github-token: ${{ secrets.TOKEN }} 
          script: |
            const payload = context.payload.client_payload;
            
            // Lấy thông tin Repo ĐÍCH từ payload
            const targetOwner = payload.target_owner;
            const targetRepo = payload.target_repo;
            const branch = payload.branch || 'main';
            const commitMessage = payload.commit_message || '.';
            const files = JSON.parse(payload.files_payload || '[]');

            if (files.length === 0) {
              console.log('Không có file nào được truyền. Action kết thúc.');
              return;
            }

            // Ghi đè URL API để trỏ đến Repo ĐÍCH (ntnhan306/file)
            const API_URL = `https://api.github.com/repos/${targetOwner}/${targetRepo}`;

            // --- CÁC BƯỚC GỌI GIT DATABASE API ---
            // 1. Lấy SHA của HEAD commit trên Repo ĐÍCH
            const { data: refData } = await github.request(`GET /repos/${targetOwner}/${targetRepo}/git/refs/heads/${branch}`);
            const baseCommitSha = refData.object.sha;
            
            // 2. Lấy Tree SHA
            const { data: { tree: { sha: baseTreeSha } } } = await github.rest.git.getCommit({
              owner: targetOwner, repo: targetRepo, commit_sha: baseCommitSha
            });
            
            // 3. Tạo Blobs và Tree Items
            const treeItems = [];
            const rawUrls = [];
            
            for (const file of files) {
              const { data: blobData } = await github.rest.git.createBlob({
                owner: targetOwner, repo: targetRepo, 
                content: file.content_base64,
                encoding: 'base64'
              });
              
              treeItems.push({
                path: file.filename,
                mode: '100644',
                type: 'blob',
                sha: blobData.sha
              });
              rawUrls.push(`https://raw.githubusercontent.com/${targetOwner}/${targetRepo}/${branch}/${file.filename}`);
            }

            // 4. Tạo New Tree
            const { data: newTreeData } = await github.rest.git.createTree({
              owner: targetOwner, repo: targetRepo, base_tree: baseTreeSha, tree: treeItems
            });

            // 5. Tạo New Commit
            const { data: newCommitData } = await github.rest.git.createCommit({
              owner: targetOwner, repo: targetRepo, message: commitMessage, tree: newTreeData.sha, parents: [baseCommitSha]
            });
            
            // 6. Cập nhật HEAD (ref)
            await github.rest.git.updateRef({
              owner: targetOwner, repo: targetRepo, ref: `heads/${branch}`, sha: newCommitData.sha
            });
            
            console.log(`✅ Commit thành công vào repo ĐÍCH: ${targetRepo}! SHA: ${newCommitData.sha}`);
            console.log('--- Link Raw ---');
            rawUrls.forEach(url => console.log(url));
        
        env:
          PAYLOAD_FILES: ${{ github.event.client_payload.files_payload }}
          PAYLOAD_BRANCH: ${{ github.event.client_payload.branch }}
